<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reportes · Al Sahara (B-12 & B-14)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f7f7f5}
    .card{border-radius:14px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    .kpi{border-radius:14px}
    @media print{ .no-print{display:none!important} body{background:#fff} .card{box-shadow:none;border:0} }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark no-print">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Al Sahara</a>
    <div class="d-flex gap-3">
      <a class="nav-link text-white-50" href="catalogo.html">Catálogo</a>
      <a class="nav-link text-white-50" href="admin_productos.html">Admin</a>
    </div>
  </div>
</nav>

<main class="container py-4" style="max-width:1100px">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h1 class="h4 m-0">Reportes de ventas</h1>
    <div class="no-print d-flex gap-2">
      <button id="btn-export" class="btn btn-outline-secondary">Exportar CSV</button>
      <button id="btn-print" class="btn btn-outline-dark">Imprimir</button>
      <button id="btn-seed" class="btn btn-primary">Simular venta ahora</button>
    </div>
  </div>

  <!-- Filtros (US-12) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Fecha inicio</label>
          <input id="from" type="date" class="form-control"/>
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Fecha fin</label>
          <input id="to" type="date" class="form-control"/>
        </div>
        <div class="col-sm-12 col-md-6 d-flex gap-2">
          <button id="btn-apply" class="btn btn-primary flex-grow-1">Aplicar filtros</button>
          <button id="btn-clear" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
      <div class="form-text mt-2">Si no aplicas filtros, se muestran los **totales generales** (US-14).</div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Total ventas</div>
          <div id="k-total" class="h4 mono m-0">$0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">N° pedidos</div>
          <div id="k-orders" class="h4 mono m-0">0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Ticket promedio</div>
          <div id="k-avg" class="h4 mono m-0">$0</div>
        </div>
      </div>
    </div>
    <div class="col-sm-6 col-lg-3">
      <div class="kpi card shadow-sm">
        <div class="card-body">
          <div class="text-muted small">Última venta</div>
          <div id="k-last" class="h6 mono m-0">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Totales por categoría -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h2 class="h6 mb-3">Totales por categoría</h2>
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
          <tr><th>Categoría</th><th class="text-end">Ventas</th><th class="text-end">Pedidos</th></tr>
          </thead>
          <tbody id="tbody-cat"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tabla de pedidos -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h6 mb-3">Pedidos</h2>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
          <tr>
            <th>Fecha</th>
            <th>Orden</th>
            <th>Cliente</th>
            <th>Categorías</th>
            <th class="text-end">Total</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="empty" class="text-center text-muted py-4 d-none">No hay pedidos en el rango seleccionado.</div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const LS_KEY = "alsahara.sales";

  // ---- Utilidades
  const money = n => "$" + Number(n||0).toLocaleString();
  const toISO = d => new Date(d).toISOString();
  const fmtDate = d => new Date(d).toLocaleString();

  // ---- Seed si no hay ventas
  function seedIfEmpty(){
    const raw = localStorage.getItem(LS_KEY);
    if(raw) return;
    const cat = ["Entradas","Platos","Postres"];
    const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const today = new Date();
    const items = [];
    for(let i=0;i<24;i++){
      const d = new Date(today); d.setDate(today.getDate()-rnd(0,25)); d.setHours(rnd(9,21), rnd(0,59), 0, 0);
      const total = 3000*rnd(2,6) + 500*rnd(0,4);
      const cs = Array.from(new Set(Array.from({length:rnd(1,3)}, _=> cat[rnd(0,2)]))).sort();
      items.push({
        id: "ORD-"+String(100000+i),
        ts: d.toISOString(),
        customer: ["Ana","Pedro","Sofía","Diego","Camila","Luis"][rnd(0,5)]+" "+["L.","G.","R.","M."][rnd(0,3)],
        cats: cs,
        total
      });
    }
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }

  function load(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
    catch(_){ return []; }
  }
  function save(arr){
    localStorage.setItem(LS_KEY, JSON.stringify(arr));
  }

  // ---- Filtros por fecha (US-12)
  function applyFilters(list){
    const f = $("from").value ? new Date($("from").value) : null;
    const t = $("to").value ? new Date($("to").value+"T23:59:59") : null;
    return list.filter(o=>{
      const d = new Date(o.ts);
      if(f && d < f) return false;
      if(t && d > t) return false;
      return true;
    });
  }

  function groupByCategory(list){
    const map = {};
    for(const o of list){
      const set = o.cats && o.cats.length ? o.cats : ["Sin categoría"];
      for(const c of set){
        if(!map[c]) map[c] = { total:0, orders:0 };
        map[c].total += o.total;
        map[c].orders += 1;
      }
    }
    return map;
  }

  function render(){
    const all = load();
    const filtered = applyFilters(all);

    // KPIs
    const total = filtered.reduce((s,o)=>s+o.total,0);
    const n = filtered.length;
    const avg = n ? total/n : 0;
    const last = filtered.slice().sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];

    $("k-total").textContent = money(total);
    $("k-orders").textContent = String(n);
    $("k-avg").textContent = money(avg);
    $("k-last").textContent = last ? fmtDate(last.ts) : "—";

    // Categorías
    const gc = groupByCategory(filtered);
    const rowsCat = Object.keys(gc).sort().map(c=>`
      <tr>
        <td>${c}</td>
        <td class="text-end mono">${money(gc[c].total)}</td>
        <td class="text-end mono">${gc[c].orders}</td>
      </tr>
    `).join("");
    $("tbody-cat").innerHTML = rowsCat || `<tr><td colspan="3" class="text-center text-muted">Sin datos</td></tr>`;

    // Tabla pedidos
    const rows = filtered
      .sort((a,b)=>new Date(b.ts) - new Date(a.ts))
      .map(o=>`
        <tr>
          <td class="mono">${fmtDate(o.ts)}</td>
          <td class="mono">${o.id}</td>
          <td>${o.customer}</td>
          <td>${(o.cats||[]).join(", ")||"—"}</td>
          <td class="text-end mono">${money(o.total)}</td>
        </tr>
      `).join("");
    $("tbody").innerHTML = rows;
    $("empty").classList.toggle("d-none", filtered.length>0);
  }

  // ---- Export CSV
  function exportCSV(){
    const all = applyFilters(load());
    const header = ["fecha","orden","cliente","categorias","total"];
    const lines = [header.join(",")].concat(all.map(o=>
      [
        new Date(o.ts).toISOString(),
        o.id,
        `"${(o.customer||"").replace(/"/g,'""')}"`,
        `"${(o.cats||[]).join("|").replace(/"/g,'""')}"`,
        o.total
      ].join(",")
    ));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reportes_alsahara.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---- Simular venta (para evidencias rápidas)
  function simulateSale(){
    const names = ["Ana","Pedro","Sofía","Diego","Camila","Luis"];
    const cats = ["Entradas","Platos","Postres"];
    const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    const sale = {
      id: "ORD-"+String(Math.floor(Math.random()*900000)+100000),
      ts: new Date().toISOString(),
      customer: names[rnd(0,names.length-1)]+" "+["L.","G.","R.","M."][rnd(0,3)],
      cats: Array.from(new Set(Array.from({length:rnd(1,3)}, _=> cats[rnd(0,2)]))).sort(),
      total: 3000*rnd(2,6) + 500*rnd(0,4)
    };
    const all = load();
    all.push(sale);
    save(all);
    render();
  }

  // ---- Eventos UI
  $("btn-apply").addEventListener("click", render);
  $("btn-clear").addEventListener("click", ()=>{
    $("from").value = ""; $("to").value = ""; render();
  });
  $("btn-export").addEventListener("click", exportCSV);
  $("btn-print").addEventListener("click", ()=>window.print());
  $("btn-seed").addEventListener("click", simulateSale);

  // Init
  seedIfEmpty();
  // Prefill: rango de este mes
  const now = new Date();
  const first = new Date(now.getFullYear(), now.getMonth(), 1);
  $("from").value = first.toISOString().slice(0,10);
  $("to").value = now.toISOString().slice(0,10);
  render();
})();
</script>
</body>
</html>